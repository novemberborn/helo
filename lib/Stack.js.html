<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stack - Stack.js</title>

  <link rel="stylesheet" href="../assets/style.css">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"/>
  <meta name="groc-relative-root" content="../"/>
  <meta name="groc-document-path" content="lib/Stack.js"/>
  
</head>
<body>
  <div id="file-area">
    <div id="meta">
      <code class="file-path">
      
        <a href="https://github.com/novemberborn/helo/blob/master/lib/Stack.js">lib/Stack.js</a>
      
      </code>
    </div>
    <div id="document">
    
      <div class="segment">
      
      
        <div class="code"><div class="wrapper"><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter;
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);

<span class="hljs-keyword">var</span> BaseRequest = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./_BaseRequest'</span>);
<span class="hljs-keyword">var</span> RequestHandler = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./_RequestHandler'</span>);
<span class="hljs-keyword">var</span> chunkifyForm = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./_chunkifyForm'</span>);
<span class="hljs-keyword">var</span> chunkifyJson = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./_chunkifyJson'</span>);
<span class="hljs-keyword">var</span> warrantPromise = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./_warrantPromise'</span>);

<span class="hljs-keyword">var</span> hop = {}.hasOwnProperty;
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h1 id="stack"><a href="#stack" class="anchor"></a>Stack</h1></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Creates a request handling stack. <a href="../doc/Events.md.html">Emits events</a>
related to the request lifecycle.</p>
</div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="stack-"><a href="#stack-" class="anchor"></a>Stack()</h2></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Can be called without <code>new</code>.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Stack</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Stack)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Stack();
  }

  EventEmitter.call(<span class="hljs-keyword">this</span>);
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="stack-request-incomingmessage-"><a href="#stack-request-incomingmessage-" class="anchor"></a>Stack#Request(incomingMessage)</h2></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Wraps an incoming message in a Helo request. Each stack instance has its
own constructor so properties can safely be added to the prototype without
affecting other stacks in the same process.</p>
</div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Use <code>Stack#addRequestInitializer()</code> to add properties to the request as
it&#39;s instantiated.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> initializers = [];
  <span class="hljs-keyword">this</span>.Request = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(incomingMessage)</span> {</span>
    BaseRequest.call(<span class="hljs-keyword">this</span>, incomingMessage);

    initializers.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func)</span> {</span>
      func.call(<span class="hljs-keyword">this</span>);
    }, <span class="hljs-keyword">this</span>);
  };
  util.inherits(<span class="hljs-keyword">this</span>.Request, BaseRequest);
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="stack-contenttypes"><a href="#stack-contenttypes" class="anchor"></a>Stack#contentTypes</h2></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Configures the default content types for <code>html</code>, <code>json</code> and <code>form</code>
<a href="../doc/Responses.md.html#body">responses</a>. Each stack instance has its own
object so properties can safely be modified without affecting other stacks
in the same process.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">  <span class="hljs-keyword">this</span>.contentTypes = {
    html: <span class="hljs-string">'text/html; charset=utf-8'</span>,
    json: <span class="hljs-string">'application/json; charset=utf-8'</span>,
    form: <span class="hljs-string">'application/x-www-form-urlencoded; charset=utf-8'</span>
  };
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="stack-chunkifiers"><a href="#stack-chunkifiers" class="anchor"></a>Stack#chunkifiers</h2></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Helper methods for converting responses into buffers. Only
<a href="../doc/Responses.md.html#json"><code>json</code></a> and
<a href="../doc/Responses.md.html#form"><code>form</code></a> are defined.
Each stack instance has its own object so the implementation can safely be
overridden without affecting other stacks in the same process.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">  <span class="hljs-keyword">this</span>.chunkifiers = {</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>The default <code>json</code> implementation simply uses <code>JSON.stringify(value)</code>.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">    json: chunkifyJson,</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>The default <code>form</code> implementation can only serialize strings, booleans
and finite numbers.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">    form: chunkifyForm
  };

  <span class="hljs-keyword">this</span>._requestHandler = <span class="hljs-keyword">new</span> RequestHandler(
    <span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.Request, <span class="hljs-keyword">this</span>.contentTypes, <span class="hljs-keyword">this</span>.chunkifiers);

  <span class="hljs-keyword">this</span>._initializers = initializers;
  <span class="hljs-keyword">this</span>._middlewares = [];
  <span class="hljs-keyword">this</span>._finalized = <span class="hljs-literal">null</span>;
}

util.inherits(Stack, EventEmitter);

module.exports = Stack;
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="stack-addrequestinitializer-initializer-"><a href="#stack-addrequestinitializer-initializer-" class="anchor"></a>Stack#addRequestInitializer(initializer)</h2></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Registers a function which will be called on a request as it&#39;s instantiated.
Initializers are called in the order in which they&#39;ve been registered. They
can be added even after the stack has been finalized.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">Stack.prototype.addRequestInitializer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(initializer)</span> {</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> initializer !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Expected `initializer` to be a function.'</span>);
  }
  <span class="hljs-keyword">this</span>._initializers.push(initializer);
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Returns the stack for easy chaining.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="stack-addmiddleware-factory-"><a href="#stack-addmiddleware-factory-" class="anchor"></a>Stack#addMiddleware(factory)</h2></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Registers a factory method that returns a middleware function. When the stack
is finalized each factory is called in order to compute the middleware chain.
Factories are called with a single argument, being the next function in the
chain. They&#39;re expected to return a function that takes a single <code>request</code>
argument.</p>
</div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>This middleware function should either return a response or call the next
function with the <code>request</code>. The result of calling the next function will
always be a promise, which should be returned or used to change a response.</p>
</div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Cannot be called after the stack has been finalized.</p>
</div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Example factory:</p>
</div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><pre><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">noop</span><span class="hljs-params">(next)</span></span> {
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(request)</span></span> {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">next</span>(request);
  };
}
</code></pre></div>
        </div>
      
      
        <div class="code"><div class="wrapper">Stack.prototype.addMiddleware = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(factory)</span> {</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> factory !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Expected `factory` to be a function.'</span>);
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._finalized) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Can’t add middleware once finalized.'</span>);
  }
  <span class="hljs-keyword">this</span>._middlewares.push(factory);
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Returns the stack for easy chaining.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="stack-install-plugin-"><a href="#stack-install-plugin-" class="anchor"></a>Stack#install(plugin)</h2></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Installs a plugin: an object that may have <code>requestInitializer</code> and / or
<code>middleware</code> functions.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">Stack.prototype.install = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(plugin)</span> {</span>
  <span class="hljs-keyword">if</span> (!plugin || <span class="hljs-keyword">typeof</span> plugin !== <span class="hljs-string">'object'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Expected `plugin` to be an object.'</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-string">'requestInitializer'</span> <span class="hljs-keyword">in</span> plugin) {
    <span class="hljs-keyword">this</span>.addRequestInitializer(plugin.requestInitializer);
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'middleware'</span> <span class="hljs-keyword">in</span> plugin) {
    <span class="hljs-keyword">this</span>.addMiddleware(plugin.middleware);
  }
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Returns the stack for easy chaining.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="stack-finalize-responder-"><a href="#stack-finalize-responder-" class="anchor"></a>Stack#finalize(responder)</h2></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Computes the middleware chain, ending with a call to <code>responder</code>. A stack can
only be finalized once.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">Stack.prototype.finalize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(responder)</span> {</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._finalized) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Can’t invoke `finalize()` more than once.'</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> responder !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Expected `responder` to be a function.'</span>);
  }
  <span class="hljs-keyword">this</span>._finalized = <span class="hljs-keyword">this</span>._middlewares.reduceRight(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(next, middleware)</span> {</span>
    <span class="hljs-keyword">return</span> middleware(warrantPromise(next));
  }, responder);
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Returns the stack for easy chaining.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="stack-seterrorresponse-response-"><a href="#stack-seterrorresponse-response-" class="anchor"></a>Stack#setErrorResponse(response)</h2></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Define a standard error response. <code>response</code> must be an object with
<code>statusCode</code> and <code>chunk</code> properties, and optionally <code>headers</code>. The response
is used based on its status code.</p>
</div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>The <code>503</code> response is used when the response promise is rejected with an
error that has a <code>cancel</code> as its <code>name</code>. Similarly if the error has <code>timeout</code>
as its <code>name</code>, the <code>504</code> response is used. For all other errors the <code>500</code>
response is used.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">Stack.prototype.setErrorResponse = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(response)</span> {</span>
  <span class="hljs-keyword">if</span> (!response || <span class="hljs-keyword">typeof</span> response !== <span class="hljs-string">'object'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Expected `response` to be an object.'</span>);
  }
  <span class="hljs-keyword">if</span> (!hop.call(response, <span class="hljs-string">'statusCode'</span>)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Expected `response.statusCode`.'</span>);
  }

  <span class="hljs-keyword">this</span>._requestHandler.setErrorResponse(response);
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Returns the stack for easy chaining.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="stack-observe-server-"><a href="#stack-observe-server-" class="anchor"></a>Stack#observe(server)</h2></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Handles <a href="http://nodejs.org/api/http.html#http_event_request"><code>request</code>
events</a> emitted by
<code>server</code>.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">Stack.prototype.observe = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(server)</span> {</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._finalized) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Can’t observe server before invoking `finalize()`.'</span>);
  }

  <span class="hljs-keyword">this</span>._requestHandler.observe(server, <span class="hljs-keyword">this</span>._finalized);
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Returns the stack for easy chaining.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="stack-cancelrequests-"><a href="#stack-cancelrequests-" class="anchor"></a>Stack#cancelRequests()</h2></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Cancels all pending response promises.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">Stack.prototype.cancelRequests = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">this</span>._requestHandler.cancelAll();
};
</div></div>
      
      </div>
    
    </div>
  </div>

  <script src="../toc.js"></script>
  <script src="../assets/libs.js"></script>
  <script src="../assets/behavior.js"></script>
</body>
</html>